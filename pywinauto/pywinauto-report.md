# Введение (глава 1)

## Интерфейс

Интерфейс - это способ взаимодействия некоторой системы с внешним миром (другими системами).

Типы интерфейсов: 

- Интерфейс между пользователем и компьютером называется пользовательским интерфейсом (*UI - User Interface*) - способ взаимодействия пользователя с программной системой (операционной системой и приложениями).
 - Консольный (*CUI - Console User Interface*).
 - Графический (*GUI - Graphical User Interface*).
 - Web – интерфейс.
- Интерфейс между программами называется программным интерфейсом (*API - Application Program Interface*) – интерфейс, который программная система реализует, для того, чтобы другая программа могла с ней взаимодействовать.

## Win32 API

**Win32 API** – библиотека ОС Windows, набор классов, процедур, функций, структур и констант, которые используют программы для создания и работы с окнами в OC Windows.

С помощью Win32 API можно создавать приложения с графическим интерфейсом пользователя, включающим диалоговые окна и стандартные элементы управления в них.

Разработчик несет ответственность за создание доступных и понятных конечному пользователю программных интерфейсов.

Win32 API существует с 1985 года и используется по сей день в огромном количестве программных решений, поэтому создание доступных и понятных пользователю Win32 API приложений - важный навык в работе программиста.

## Графический интерфейс ОС Windows

- Графический интерфейс ОС Windows - оконная система.
- Окна - системные объекты ОС Windows.
- ОС создает и работает со всеми окнами.
- Окна занимают некоторую область экрана, с которой взаимодействует пользователь.
- Для каждого окна в ОС создается объект соответствующего класса, который имеет уникальный номер – дескриптор (*hwnd - handle of window*).
- ОС общается с окнами посредством оконных сообщений (window message).

### Окна ОС Windows

Все окна можно разделить на две группы:

- Окна верхнего уровня – активное окно (active window):
 - одновременно в системе может быть активным только одно окно верхнего уровня.
 - пользователь может менять их положение и размеры; 
 - пользователь может разворачивать на весь экран дисплея или сворачивать в иконку на панели задач (task bar);
 - при закрытии окна верхнего уровня – программа завершает свою работу.
- Дочерние окна (child window):
 - связаны с родительскими окнами (сами могут быть родительскими окнами);
 - могут размещаться только в рабочей области родительского окна;
 - при закрытии родительского окна тоже закрываются.

Типы окон в ОС Windows:

- основные окна - используются для представления всего приложения; они включают основные элементы интерфейса и инициируют создание других окон;
- диалоговые окна - предназначены для получения информации и запуска на выполнения разных вспомогательных задач приложения;
- элементы управления (control) - дочерние окна, которые используются для выполнения элементарных операций по отображению информации или для получения некоторых команд пользователя.

### Оконные сообщения

- ОС оповещает окна о всех событиях, которые происходят на компьютере с помощью сообщений.
- Для каждой прикладной программы с графическим интерфейсом создается очередь сообщений (message queue). В эту очередь ОС отправляет все сообщения:
 - об изменении состояния окна (Constructor, Load, Activated, Closing, Closed);
 - об изменении в работе ОС;
 - о выборе пользователем команд меню или нажатии кнопок;
 - о действиях пользователя с мышью и клавиатурой;
 - и т.д.
- В сообщении передается код события, номер окна, с которым связано это сообщение, параметры события, время события.
- В программе сообщения преобразуются в события.
- Сообщения о всех операциях пользователя с мышью и клавиатурой получает окно, которое имеет фокус ввода.
- Сообщения отправляются в очередь сообщений того приложения, которому данное окно принадлежит.

## Создание оконных приложений ОС Windows

Использование чистого Win32 API для создания GUI-приложений вызывает множество трудностей. Программисту приходится вручную прописывать создание окон приложения со всеми их свойствами, вручную настраивать взаимодействие окон посредством оконных сообщений, обрабатывать всевозможные события.

Для упрощения создания оконных приложений было написано множество библиотек-надстроек над Win32 API. Эти библиотеки предоставляют объектно-ориентированный набор оберток (wrappers) над множеством функций Windows API, делающий работу с ними более удобной. Этот набор представляет в виде классов языка программирования множество встроенных в систему объектов (окна, виджеты, файлы и т.п.) и берет на себя рутинные действия по работе с дескрипторами, выделению и освобождению памяти и т.д.

Примерами таких библиотек являются MFC и WTL:

- **MFC - Microsoft Foundation Classes** - библиотека на языке C++, разработанная Microsoft, призванная облегчить разработку GUI-приложений для ОС Windows. Библиотека MFC облегчает работу с GUI путем создания каркаса приложения - "скелетной" программы, автоматически создаваемой по заданному макету и полностью берущей на себя рутинные действия по его обслуживанию (обработка оконных событий, пересылка данных между внутренними буферами элементов и переменными программы и т.п.).
- **WTL - Windows Template Library** - библиотека шаблонов (шаблонных классов) C++, предназначенная для написания стандартных GUI приложений Windows. WTL первую очередь разрабатывалась как облегчённая альтернатива библиотеке MFC. В библиотеке представлены основные элементы управления: меню, панели инструментов, кнопки, поля ввода, списки и т.д. 

## Управление GUI-приложениями ОС Windows

Как уже говорилось, оконными приложениями пользователь может управлять с помощью клавиатуры и мыши. Однако иногда этого недостаточно для достижения желаемого результата. Например, пользователю необходимо использовать одну и ту же программу с графическим интерфейсом множество раз для выполнения какой-нибудь рутинной работы. Каждый раз кликать мышкой по кнопкам на главном окне программы заняло бы большое количество времени. Поэтому логично было бы поискать пути для автоматизации GUI-приложений. Необходимо уметь управлять приложением из других программ.

### Win32 Accessibility технологии Microsoft

Для того чтобы получить программный доступ к внутренностям Win32 API приложений, существуют ориентированные на управление API (API для управления другими API).

На операционной системе Windows существует 2 вида API, позволяющих получить программный доступ к элементам управления Win32 API:

- **Microsoft Active Accessibility (MSAA)** - старый управляющий интерфейс, основанный на интерфейсе IAccessible Component Object Model (COM).
- **User Interface Automation (UIA)** -  управляющий API, поддерживаемый более новыми элементами управления, который также может воспользоваться интерфейсом MSAA для получения доступа к элементам управления.

#### Microsoft Active Accessibility

**MSAA** - технология, основанная на Component Object Model (COM) - модели, описывающей правила взаимодействия приложений и операционной системы - и предоставляющая средства для работы с приложениями, работающими на операционной системе Microsoft Windows. Она включает в себя динамически подключаемые библиотеки на языке C++, включенные в операционную систему, а также COM-интерфейс и элементы API, которые дают возможность получить информацию об элементах пользовательского интерфейса и веб-контента.

Используя эту информацию, вспомогательные программные продукты могут представить пользовательский интерфейс приложения в абсолютно другом виде, например, как речь или шрифт Брайля, и с помощью голосовых команд человек может удаленно управлять пользовательским интерфейсом.

MSAA состоит из следующих компонент:

- IAccessible COM-интерфейс, который позволяет получить информацию об элементах пользовательского интерфейса, а также управлять ими.
- WinEvents - событийная система, позволяющая серверу оповестить клиентов о том, что управляемый объект изменил свое состояние.
- Вспомогательная библиотека Oleacc.dll.

#### UI Automation

**UIA** представляет из себя библиотеку виртуализации дерева элементов пользовательского интерфейса произвольного Win32, Windows Forms или WPF приложения, с возможностью последующего доступа к свойствам этих элементов, а также их управлением. UIA является практически прямым наследником MSAA. 

UIA состоит из следующих компонент:

- Provider API (UIAutomationProvider.dll, UIAutomationTypes.dll) - набор функций, позволяющих получить информацию об элементах пользовательского интерфейса и принять пользовательский ввод.
- Client API (UIAutomationClient.dll, UIAutomationTypes.dll) - набор типов для управляющего кода, которые получают информацию о пользовательском интерфейсе и отправляют пользовательский ввод элементам интерфейса.
- UiAutomationCore.dll - базовый код, обеспечивающий взаимодействие между поставщиками и клиентами.
- UIAutomationClientsideProviders.dll - набор UI Automation поставщиков для стандартных элементов пользовательского интерфейса.

Каждый элемент пользовательского интерфейса представляется в виде объекта типа AutomationElement, который предоставляет методы для получения свойств элемента, поиска его дочерних элементов, генерации событий.


### Другие Accessibility технологии (подход к pywinauto, разнообразие приложений - возможно, перенести это уже в главу 2)

Предоставленными Microsoft Accessibility технологиями не всегда можно воспользоваться. Во-первых, их применение ограничено языками C++ и C#. Во-вторых, не все современные приложения поддерживают родную оконную систему ОС Windows.

Сегодня существует огромное множество различных видов приложений, например, Windows Forms (WF) приложения, Windows Presentation Foundation (WPF) приложения, приложения из магазина Windows Store для Windows 8+. Некоторые из них, например WF, частично поддерживают оконную систему (диалоги, стандартные элементы управления). Но другие могут совсем не иметь окон в привычном смысле (представляемых объектом, имеющим дескриптор - hwnd).

В связи с этим появляются новые Accessibility технологии, позволяющие получить доступ к элементам приложений различных видов и написанные на разных языках.

---

# Существующие Accessibility технологии (глава 2)

TBD

---

# pywinauto (глава 3)

TBD

---

# UI Automation и pywinauto (глава 4)

TBD

---

# Заключение (глава 5)

TBD

---

# Литература (глава 6)

1. Windows (Win32) Accessibility for Developers. URL: <https://msdn.microsoft.com/en-us/windows/desktop/gg712214.aspx> (дата обращения: 07.05.2016).
2. Microsoft Active Accessibility. URL: <https://msdn.microsoft.com/en-us/library/windows/desktop/dd373592(v=vs.85).aspx> (дата обращения: 07.05.2016).
3. UI Automation. URL: <https://msdn.microsoft.com/en-us/library/ms747327(v=vs.110).aspx> (дата обращения: 07.05.2016).
4. Написание автоматических тестов для тестирования пользовательского интерфейса десктопных приложений. URL: <https://habrahabr.ru/post/124110/> (дата обращения: 07.05.2016).
5. Win32 API по шагам (окна). URL: <http://www.firststeps.ru/mfc/winapi/win/apiwind1.html> (дата обращения: 17.05.2016).
6. MFC Reference. URL: <https://msdn.microsoft.com/en-us/library/d06h2x6e(v=vs.100).aspx> (дата обращения: 17.05.2016).
7. Windows Runtime C++ Template Library (WRL). URL: <https://msdn.microsoft.com/en-us/library/hh438466.aspx> (дата обращения: 17.05.2016).