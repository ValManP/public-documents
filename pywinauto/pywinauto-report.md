# Введение (+ постановка задач, глава 1)

Графический интерфейс пользователя – разновидность пользовательского интерфейса, в котором элементы интерфейса (меню, кнопки, значки, списки и т.п.), представленные пользователю на дисплее, исполнены в виде графических изображений.

Автоматизация GUI - одно из важных направлений современной IT индустрии. Она позволяет выполнять такие задачи, как:

- Многократное выполнение однотипных операций или выполнение большого количества простых операций с GUI приложения.
- Автоматическое тестирование GUI (ошибки в функциональности посредством GUI, необработанные исключения, ошибки в самом интерфейсе и т.п.).
- Извлечение информации из GUI приложения (составление отчетов о работе программы, использование результатов работы программы в качестве входных данных для другой и т.п.).

На сегодняшний день существует множество различных по виду, способу работы и поддерживаемым классам приложений инструментов для автоматизации GUI. Некоторые представляют собой библиотеку для использования с каким-либо языком программирования или же отдельное приложение (программа для управления другими программами). Одни позволяют лишь сымитировать работу с клавиатурой и мышью, другие же могут получить доступ к каждому элементу GUI приложения. Существуют как платные, так и open-source (с открытым исходным кодом) решения.

Каждый из этих инструментов поддерживает определенный вид приложений, и программист может не найти подходящего для своей задачи по автоматизации GUI open-source решения. Поэтому ему придется выходить из ситуации, либо упрощая свою задачу по автоматизации, либо используя сразу несколько доступных инструментов, разбивая задачу на части, либо рассматривать вариант использования платных проектов.

В связи с этим задача разработки удобного, поддерживающего большой набор приложений инструмента для автоматизации GUI является актуальной на сегодняшний день.

Желаемый результат - получить инструмент, который:

- Написан на языке Python, популярном скриптовом языке общего назначения, ориентированном на повышение производительности разработчика и читаемости кода.
- Может быть использован в качестве подключаемой Python библиотеки.
- Прост в обращении и имеет интуитивно понятный интерфейс.
- Поддерживает приложения разного вида (Native, Windows Forms, Windows Presentation Foundation).
- Основан на подходе использования Accessibility технологий для получения доступа к элементам GUI.
- Имеет открытый исходный код.

За основу для работы взята существующая Python библиотека для автоматизации GUI приложений - **pywinauto** [8].

**pywinauto** - набор Python модулей, позволяющий управлять GUI приложениями, посылая действия клавиатуры и мыши окнам и отдельным элементам приложения.

Особенности pywinauto:

- Имеет открытый исходный код, доступный на сайте www.github.com [8].
- Имеет всего одну обязательную зависимость - библиотеку pyWin32.
- Позволяет обращаться к конкретному элементу GUI, используя Accessibility технологии.
- ~~Позволяет посылать команды клавиатуры и мыши, используя координатный метод автоматизации GUI~~.
- Имеет удобный интерфейс.
- Поддерживает приложения, использующие оконную систему ОС Windows.
- Имеет удобный интерфейс.

Подробнее подробнее об Accessibility технологиях, подходах к автоматизации GUI, оконной системе ОС Windows в разделе *Графический интерфейс Windows*.

Подробнее о pywinauto в разделе *Библиотека pywinauto*.

Целями данной работы являются:

- Изучение библиотеки pywinauto, принципа ее работы, структуры.
- Расширение класса поддерживаемых библиотекой приложений (Windows Forms, Windows Presentation Foundation, Windows Store Applications) путем использования Accessibility технологии User Interface Automation на ОС Windows.
- Поддержка библиотеки путем устранения неисправностей (issues) и взаимодействия с конечными пользователями.

---

# Графический интерфейс Windows (глава 2)

## Интерфейс

Интерфейс - это способ взаимодействия некоторой системы с внешним миром (другими системами).

Типы интерфейсов: 

- Интерфейс между пользователем и компьютером называется пользовательским интерфейсом (*UI - User Interface*) - способ взаимодействия пользователя с программной системой (операционной системой и приложениями).
 - Консольный (*CUI - Console User Interface*).
 - Графический (*GUI - Graphical User Interface*).
 - Web-интерфейс.
- Интерфейс между программами называется программным интерфейсом (*API - Application Program Interface*) - интерфейс, который программная система реализует, для того, чтобы другая программа могла с ней взаимодействовать.

## Win32 API

**Win32 API** – библиотека ОС Windows, набор классов, процедур, функций, структур и констант, которые используют программы для создания и работы с окнами в OC Windows.

С помощью Win32 API можно создавать приложения с графическим интерфейсом пользователя, включающим диалоговые окна и стандартные элементы управления в них.

Разработчик несет ответственность за создание доступных и понятных конечному пользователю программных интерфейсов.

Win32 API существует с 1985 года и используется по сей день в огромном количестве программных решений, поэтому создание доступных и понятных пользователю Win32 API приложений - важный навык в работе программиста.

## Оконная система ОС Windows

- Графический интерфейс ОС Windows - оконная система.
- Окна - системные объекты ОС Windows.
- ОС создает и работает со всеми окнами.
- Окна занимают некоторую область экрана, с которой взаимодействует пользователь.
- Для каждого окна в ОС создается объект соответствующего класса, который имеет уникальный номер – дескриптор (*hwnd - handle of window*).
- ОС общается с окнами посредством оконных сообщений (window message).

### Окна ОС Windows

Все окна можно разделить на две группы:

- Окна верхнего уровня – активное окно (active window):
 - одновременно в системе может быть активным только одно окно верхнего уровня.
 - пользователь может менять их положение и размеры; 
 - пользователь может разворачивать на весь экран дисплея или сворачивать в иконку на панели задач (task bar);
 - при закрытии окна верхнего уровня – программа завершает свою работу.
- Дочерние окна (child window):
 - связаны с родительскими окнами (сами могут быть родительскими окнами);
 - могут размещаться только в рабочей области родительского окна;
 - при закрытии родительского окна тоже закрываются.

Типы окон в ОС Windows:

- основные окна - используются для представления всего приложения; они включают основные элементы интерфейса и инициируют создание других окон;
- диалоговые окна - предназначены для получения информации и запуска на выполнения разных вспомогательных задач приложения;
- элементы управления (control) - дочерние окна, которые используются для выполнения элементарных операций по отображению информации или для получения некоторых команд пользователя.

### Оконные сообщения

- ОС оповещает окна о всех событиях, которые происходят на компьютере с помощью сообщений.
- Для каждой прикладной программы с графическим интерфейсом создается очередь сообщений (message queue). В эту очередь ОС отправляет все сообщения:
 - об изменении состояния окна (Constructor, Load, Activated, Closing, Closed);
 - об изменении в работе ОС;
 - о выборе пользователем команд меню или нажатии кнопок;
 - о действиях пользователя с мышью и клавиатурой;
 - и т.д.
- В сообщении передается код события, номер окна, с которым связано это сообщение, параметры события, время события.
- В программе сообщения преобразуются в события.
- Сообщения о всех операциях пользователя с мышью и клавиатурой получает окно, которое имеет фокус ввода.
- Сообщения отправляются в очередь сообщений того приложения, которому данное окно принадлежит.

## Создание оконных приложений ОС Windows

Использование чистого Win32 API для создания GUI приложений вызывает множество трудностей. Программисту приходится вручную прописывать создание окон приложения со всеми их свойствами, вручную настраивать взаимодействие окон посредством оконных сообщений, обрабатывать всевозможные события.

Для упрощения создания оконных приложений было написано множество библиотек-надстроек над Win32 API. Эти библиотеки предоставляют объектно-ориентированный набор оберток (wrappers) над множеством функций Windows API, делающий работу с ними более удобной. Этот набор представляет в виде классов языка программирования множество встроенных в систему объектов (окна, виджеты, файлы и т.п.) и берет на себя рутинные действия по работе с дескрипторами, выделению и освобождению памяти и т.д.

Примерами таких библиотек являются MFC и WTL:

- **MFC - Microsoft Foundation Classes** - библиотека на языке C++, разработанная Microsoft, призванная облегчить разработку GUI приложений для ОС Windows. Библиотека MFC облегчает работу с GUI путем создания каркаса приложения - "скелетной" программы, автоматически создаваемой по заданному макету и полностью берущей на себя рутинные действия по его обслуживанию (обработка оконных событий, пересылка данных между внутренними буферами элементов и переменными программы и т.п.).
- **WTL - Windows Template Library** - библиотека шаблонов (шаблонных классов) C++, предназначенная для написания стандартных GUI приложений Windows. WTL первую очередь разрабатывалась как облегчённая альтернатива библиотеке MFC. В библиотеке представлены основные элементы управления: меню, панели инструментов, кнопки, поля ввода, списки и т.д. 

## Управление GUI приложениями ОС Windows

Как уже говорилось, оконными приложениями пользователь может управлять с помощью клавиатуры и мыши. Однако иногда этого недостаточно для достижения желаемого результата. Например, пользователю необходимо использовать одну и ту же программу с графическим интерфейсом множество раз для выполнения какой-нибудь рутинной работы. Каждый раз кликать мышкой по кнопкам на главном окне программы заняло бы большое количество времени. Поэтому логично было бы поискать пути для автоматизации GUI приложений. Необходимо уметь управлять приложением из других программ, например, используя популярные скриптовые языки.

### Подходы к автоматизации GUI

- **Координатный метод.** Пользователь конкретно указывает координаты, куда нужно кликнуть мышью, какие клавиши нажать на клавиатуре.
- **Метод визуального поиска.** Инструмент делает снимок экрана, находит в каком месте расположен элемент, указанный пользователем, по какому либо признаку (например, тексту на кнопке) и выполняет действие с найденным элементом.
- **Применение Accessibility технологий.** Инструмент получает доступ к свойствам элементов GUI приложения посредством вызова функций Win32 API и использования оконных сообщений.

Поскольку задача данной работы является разработка инструмента, который использует третий подход, а именно, использование Accessibility технологий для получения доступа к элементам GUI, то рассмотрим подробнее эти технологии.

### Win32 Accessibility технологии

Для того чтобы получить программный доступ к внутренностям Win32 API приложений, существуют ориентированные на управление API (API для управления другими API).

На операционной системе Windows существует 2 вида API, позволяющих получить программный доступ к элементам управления Win32 API:

- **Microsoft Active Accessibility (MSAA)** - старый управляющий интерфейс, основанный на интерфейсе IAccessible Component Object Model (COM).
- **User Interface Automation (UIA)** -  управляющий API, поддерживаемый более новыми элементами управления, который также может воспользоваться интерфейсом MSAA для получения доступа к элементам управления.

#### Microsoft Active Accessibility

**MSAA** - технология, основанная на Component Object Model (COM) - модели, описывающей правила взаимодействия приложений и операционной системы - и предоставляющая средства для работы с приложениями, работающими на операционной системе Microsoft Windows. Она включает в себя динамически подключаемые библиотеки на языке C++, включенные в операционную систему, а также COM-интерфейс и элементы API, которые дают возможность получить информацию об элементах пользовательского интерфейса и веб-контента.

Используя эту информацию, вспомогательные программные продукты могут представить пользовательский интерфейс приложения в абсолютно другом виде, например, как речь или шрифт Брайля, и с помощью голосовых команд человек может удаленно управлять пользовательским интерфейсом.

MSAA состоит из следующих компонент:

- IAccessible COM-интерфейс, который позволяет получить информацию об элементах пользовательского интерфейса, а также управлять ими.
- WinEvents - событийная система, позволяющая серверу оповестить клиентов о том, что управляемый объект изменил свое состояние.
- Вспомогательная библиотека Oleacc.dll.

#### UI Automation

**UIA** представляет из себя библиотеку виртуализации дерева элементов пользовательского интерфейса произвольного Win32, Windows Forms или WPF приложения, с возможностью последующего доступа к свойствам этих элементов, а также их управлением. UIA является практически прямым наследником MSAA. 

UIA состоит из следующих компонент:

- Provider API (UIAutomationProvider.dll, UIAutomationTypes.dll) - набор функций, позволяющих получить информацию об элементах пользовательского интерфейса и принять пользовательский ввод.
- Client API (UIAutomationClient.dll, UIAutomationTypes.dll) - набор типов для управляющего кода, которые получают информацию о пользовательском интерфейсе и отправляют пользовательский ввод элементам интерфейса.
- UiAutomationCore.dll - базовый код, обеспечивающий взаимодействие между поставщиками и клиентами.
- UIAutomationClientsideProviders.dll - набор UI Automation поставщиков для стандартных элементов пользовательского интерфейса.

Каждый элемент пользовательского интерфейса представляется в виде объекта типа AutomationElement, который предоставляет методы для получения свойств элемента, поиска его дочерних элементов, генерации событий.

### Разнообразие видов приложений

Предоставленными Microsoft Accessibility технологиями не всегда можно воспользоваться. Во-первых, их применение ограничено языками C++ и C#. Во-вторых, не все современные приложения поддерживают родную оконную систему ОС Windows.

Сегодня существует огромное множество различных видов приложений, например, Windows Forms (WinForms) приложения, Windows Presentation Foundation (WPF) приложения, приложения из магазина Windows Store для Windows 8+. Некоторые из них, например WinForms, частично поддерживают оконную систему (диалоги, стандартные элементы управления). Но другие могут совсем не иметь окон в привычном смысле (представляемых объектом, имеющим дескриптор - hwnd).

В связи с этим появляются новые Accessibility технологии, позволяющие получить доступ к элементам приложений различных видов и написанные на разных языках.

---

# Существующие инструменты автоматизации GUI (глава 3)

Рассмотрим ***кратко*** перечень доступных инструментов для автоматизации GUI приложений, которые использую подход применения Accessibility технологий.

- Python инструменты:
 - PyAutoGui (<https://github.com/asweigart/pyautogui>) - кроссплатформенный инструмент, позволяющий управлять мышкой и клавиатурой (координатный метод автоматизации GUI).
 - AXUI (<https://github.com/xcgspring/AXUI>) - специализируется на автоматизации Web-интерфейса, используя платформу Selenium, но может выполнять простые действия с элементами Windows приложений, используя UIA API.
 - winGuiAuto (<http://www.brunningonline.net/simon/blog/archives/winGuiAuto.py.html>) - небольшой модуль, использующий Win32 API.
- Инструменты, написанные на других скриптовых языках:
 - Perl Win32::GuiTest (<http://winguitest.sourceforge.net/>).
 - Ruby Win32-Autogui (<https://github.com/robertwahler/win32-autogui>).
 - Ruby RAutomation (<https://github.com/jarmo/RAutomation>) - использует 3 технологии: Win32 API, UIA API, AutoIt.
 - C# Winium.Desktop (<https://github.com/2gis/Winium.Desktop>)
 - Некоторые другие (<http://www.opensourcetesting.org/functional.php>)
- Другие бесплатные инструменты:
 - AutoIt (<http://www.autoitscript.com/>)
 - Automa (<http://www.getautoma.com/>)
 - Набор инструментов: <https://github.com/atinfo/awesome-test-automation>
- Платные инструменты:
 - WinRunner (<http://www.mercury.com/us/products/quality-center/functional-testing/winrunner/>)
 - SilkTest (<http://www.segue.com/products/functional-regressional-testing/silktest.asp>)
 - Many Others (<http://www.testingfaqs.org/t-gui.html>)

https://github.com/pywinauto/pywinauto/wiki/UI-Automation-tools-ratings

---

# Библиотека pywinauto (глава 4)

TBD

---

# UI Automation и pywinauto (глава 5)

TBD

---

# Заключение (глава 6)

TBD

---

# Список использованной литературы

1. Windows (Win32) Accessibility for Developers. URL: <https://msdn.microsoft.com/en-us/windows/desktop/gg712214.aspx> (дата обращения: 07.05.2016).
2. Microsoft Active Accessibility. URL: <https://msdn.microsoft.com/en-us/library/windows/desktop/dd373592(v=vs.85).aspx> (дата обращения: 07.05.2016).
3. UI Automation. URL: <https://msdn.microsoft.com/en-us/library/ms747327(v=vs.110).aspx> (дата обращения: 07.05.2016).
4. Написание автоматических тестов для тестирования пользовательского интерфейса десктопных приложений. URL: <https://habrahabr.ru/post/124110/> (дата обращения: 07.05.2016).
5. Win32 API по шагам (окна). URL: <http://www.firststeps.ru/mfc/winapi/win/apiwind1.html> (дата обращения: 17.05.2016).
6. MFC Reference. URL: <https://msdn.microsoft.com/en-us/library/d06h2x6e(v=vs.100).aspx> (дата обращения: 17.05.2016).
7. Windows Runtime C++ Template Library (WRL). URL: <https://msdn.microsoft.com/en-us/library/hh438466.aspx> (дата обращения: 17.05.2016).
8. pywinauto - Windows GUI Automation with Python. URL: <https://github.com/pywinauto/pywinauto>